{% extends "admin/change_form.html" %}
{% load apitags staticfiles %}

{% block extrahead %}
    {{ block.super }}
    <style type="text/css">
        .field-authors > div > p.help,
        .field-editors > div > p.help,
        .field-keywords > div > p.help {
            display: none;
        }
        .field-authors p.help,
        .field-editors p.help,
        .field-keywords p.help {
            margin-left: 0 !important;
        }
        .field-authors .related-widget-wrapper,
        .field-editors .related-widget-wrapper,
        .field-keywords .related-widget-wrapper {
            min-width: 50%;
        }
        .field-authors .related-widget-wrapper > span,
        .field-editors .related-widget-wrapper > span,
        .field-keywords .related-widget-wrapper > span {
            min-width: 100% !important;
        }
        .select2-container--default .select2-selection--multiple {
            background-color: rgb(247, 247, 247);
            border: 1px solid #ccc;
        }
        .errors .select2-container--default .select2-selection--multiple {
            border: 1px solid #ba2121;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript">
        function register(event) {
            var form = $(this);
            if (window.tags_registered)
                return true;
            event.preventDefault();
            var promises = [];
            var selects = [$('#id_authors'), $('#id_editors'), $('#id_keywords')];
            $(selects).each(function (index, select) {
                console.log('Outer loop:', select);
                var select = $(select);
                var model = select.data('model');
                var options = select.find('option[data-select2-tag="true"]');
                options.each(function (index, option) {
                    console.log('Inner loop:', option);
                    option = $(option);
                    promise = $.ajax({
                        type: 'POST',
                        url: '/admin/api/resource/create_' + model + '/',
                        data: $.param({'name': option.attr('value')}),
                        dataType: 'json',
                        success: function(data) {
                            // TODO: Specify field in returned data
                            var option = $('option[value="' + data.text + '"]');
                            console.log('Success pre:', option[0]);
                            option.attr('value', data.id);
                            console.log('Success post:', option[0]);
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            option.remove();
                        }
                    });
                    promises.push(promise);
                });
            });
            console.log('Promises:', promises);
            $.when.apply($, promises).done(function (data, textStatus, jqXHR) {
                console.log('Oh hai!');
                form[0].submit();
            });
        }
    </script>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script type="text/javascript">
        $('#resource_form').submit(register);
        var keywords = {{ keywords|json }};
        var output = '';
        for (i=0; i<keywords.length; ++i) {
          if (i in keywords) {
            var keyword = keywords[i];
            output += '<a href="#">' + keyword + '</a>' + (i + 1 == keywords.length ? '' : ', ');
          }
        }
        if (output) {
            var initial = $('#keyword_suggestions').html();
            $('#keyword_suggestions').html(initial + output);
        } else {
            $('#keyword_suggestions').remove();
        }
        $('#keyword_suggestions a').click(function (event) {
            event.preventDefault();
            var text = this.text;
            var select = $('#id_keywords');
            var tags = select.val();
            if (tags === null)
                tags = new Array();
            var tag = select.find('option:contains("' + text + '")').filter(function() {
                return $(this).text() === text;});
            if (tag.length === 0) {
                select.append('<option value="-1">' + this.text + '</option>');
                tags.push('-1');
                select.trigger('change').val(tags).trigger('change');
                select.trigger({
                    type: 'select2:select',
                    params: {data: {id: -1, text: this.text}}});
            } else {
                tags.push(tag.attr('value'));
                select.trigger('change').val(tags).trigger('change');
            };
        });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script type="text/javascript">
    $( "#id_title" ).autocomplete({
        source: function (request, response) {
            var username = 'tarix2006';
            var password = 'f756e95e8b0885843fb55984abbbfb8e';
            $.ajax({
                type: "GET",
                url: "http://bibsonomy.claviger.net/api/posts?search=" + request.term + "&resourcetype=bibtex",
                crossDomain: true,
                xhrFields: {
                    withCredentials: true
                },
                headers: {
                    "Authorization": "Basic " + btoa(username + ":" + password)
                },
                success: function (data) {
                    var $xml = $(data);
                    var $posts = $xml.find("bibtex");
                    var postarray = [];
                    $posts.each(function () {
                        var post = {
                            value: $(this).attr("title"),
                            isbn: $(this).attr("isbn"),
                            author: $(this).attr("author"),
                            bibtexAbstract: $(this).attr("bibtexAbstract"),
                            entrytype: $(this).attr("entrytype"),
                            year: $(this).attr("year"),
                            link: $(this).attr("url"),
                            href: $(this).attr("href"),
                            address: $(this).attr("address"),
                            misc: $(this).attr("misc"),
                            journal: $(this).attr("journal"),
                            volume: $(this).attr("journal")
                        };
                        var link ="";
                        if ((post.misc.indexOf("ee") >= 0) ||
                                (post.misc.indexOf("http") >= 0) ||
                                        (post.misc.indexOf("https") >= 0))
                                {
                                    var res = post.misc.split(/[\{\}]/);
                                    res.forEach(function(item,i,array){
                                        if (item.indexOf("ee =")>=0){
                                            link = array[i+1];
                                        }
                                    });
                                }
                        if (!link || 0 === link.length) post.link = link;
                        postarray.push(post);
                    });
                    response(postarray);
                },
                error: function (error, status, text) {
                    console.log(error);
                    console.log(status);
                    console.log(text);
                }
            });
        }
    },
    {
        select : function(event, ui){
            $( "#id_authors .select2-search__field" ).val( ui.item.author );
            $( "#id_published" ).val( ui.item.year );
            $( "#id_url" ).val( ui.item.link );
            $( "#id_fulltext_url" ).val ( ui.item.href );
            $( "#id_abstract" ).val( ui.item.bibtexAbstract );
            $( "#id_journal" ).val( ui.item.journal );
            $( "#id_volume" ).val( ui.item.volume );
        }
    }
    );
    </script>
{% endblock %}
